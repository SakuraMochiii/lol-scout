{% extends "base.html" %}
{% block title %}{{ team.name }} — LOL IMs Info{% endblock %}
{% block content %}
<div class="team-header">
  <h1>
    {{ team.name }}
    {% if is_my_team %}<span class="my-team-badge">MY TEAM</span>{% endif %}
  </h1>
  <div class="team-header-actions">
    <button class="btn" onclick="refreshTeam('{{ team.id }}')">Refresh All</button>
    {% if data.meta.my_team_id and not is_my_team %}
    <a href="/analysis/{{ team.id }}" class="btn btn-accent">Ban/Pick Analysis</a>
    {% endif %}
  </div>
</div>

<div id="refresh-status" class="refresh-status" style="display:none"></div>

{% set starters = team.players|rejectattr("is_substitute")|list %}
{% set subs = team.players|selectattr("is_substitute")|list %}

{% if not team.players %}
<div class="empty-state">
  <p>No players on this team. <a href="/manage">Add players</a>.</p>
</div>
{% endif %}

{% if starters %}
<h2 class="section-title">Starters</h2>
<div class="player-list">
  {% for player in starters %}
  {% set stats = player.stats %}
  <div class="player-card" data-player="{{ player.id }}">
    <div class="player-header" onclick="togglePlayer(this)">
      <span class="role-tag role-{{ player.role }}">{{ player.role[:3].upper() }}</span>
      <span class="player-name">{{ player.game_name }}<span class="tag">#{{ player.tag_line }}</span></span>
      {% if stats %}
      {% set cur_higher = player|current_higher_than_peak %}
      {% if stats.peak_tier %}
      {% if cur_higher %}
      <span class="current-rank-inline">Peak: {{ stats.peak_tier }}</span>
      {% else %}
      <span class="tier-badge" style="color: {{ stats.peak_tier|peak_color }}">Peak: {{ stats.peak_tier }}</span>
      {% endif %}
      {% endif %}
      {% if stats.tier != 'UNRANKED' %}
      {% if cur_higher %}
      <span class="tier-badge" style="color: {{ stats.tier|tier_color }}">Cur: {{ player|tier_display }}</span>
      {% else %}
      <span class="current-rank-inline">Cur: {{ player|tier_display }}</span>
      {% endif %}
      {% else %}
      <span class="current-rank-inline unranked">Unranked</span>
      {% endif %}
      {% if stats.previous_season_tier %}
      <span class="past-rank-inline">Last: {{ stats.previous_season_tier }}</span>
      {% endif %}
      {% if stats.season_games > 0 %}
      <span class="wr-badge {{ 'good' if stats.season_winrate >= 52 else 'bad' if stats.season_winrate < 48 else '' }}">
        {{ stats.season_winrate }}% WR
      </span>
      <span class="games-count">{{ stats.season_games }} games</span>
      {% endif %}
      {% else %}
      <span class="tier-badge unranked">No data</span>
      {% endif %}
      <span class="expand-arrow">&#9660;</span>
    </div>

    <div class="player-body" style="display:none">
      {% if stats and stats.scrape_error %}
      <div class="alert alert-warn">{{ stats.scrape_error }}</div>
      {% endif %}

      {% if stats and (stats.previous_season_tier or stats.peak_tier or stats.season_history) %}
      <div class="extra-ranks">
        {% if stats.peak_tier %}
        <span class="muted">Peak: <strong style="color: {{ stats.peak_tier|peak_color }}">{{ stats.peak_tier }}</strong></span>
        {% endif %}
        {% if stats.previous_season_tier %}
        <span class="muted">Last Season: <strong>{{ stats.previous_season_tier }}</strong></span>
        {% endif %}
      </div>
      {% if stats.season_history %}
      <details class="season-history">
        <summary class="muted">Season History</summary>
        <div class="season-history-list">
          {% for s in stats.season_history %}
          <div class="season-row">
            <span class="season-name">{{ s.season }}</span>
            <span>{{ s.end_rank or '—' }}{% if s.end_lp %} ({{ s.end_lp }} LP){% endif %}</span>
            {% if s.peak_rank %}
            <span class="muted">Peak: {{ s.peak_rank }}{% if s.peak_lp %} ({{ s.peak_lp }} LP){% endif %}</span>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </details>
      {% endif %}
      {% endif %}

      {% if stats %}
      <div class="player-tabs">
        <button class="player-tab active" onclick="switchPlayerTab(this, 'ranked')">Ranked</button>
        <button class="player-tab" onclick="switchPlayerTab(this, 'mastery')">Mastery</button>
      </div>

      <div class="player-tab-panel" data-tab="ranked">
        {% if stats.champions %}
        <div class="champ-list">
          <div class="champ-list-header">
            <span>Champion</span><span>Games</span><span>Win Rate</span><span>KDA</span>
          </div>
          {% for champ in stats.champions[:10] %}
          <div class="champ-row">
            <div class="champ-info">
              <img class="champ-icon" src="{{ champ.champion_key|champion_icon }}"
                   alt="{{ champ.champion_name }}"
                   onerror="this.style.display='none'">
              <span class="champ-name">{{ champ.champion_name }}</span>
              {% if champ.role %}
              <span class="champ-role-tag">{{ champ.role }}</span>
              {% endif %}
              {% if loop.index == 1 and champ.games >= 10 and stats.champions|length >= 2 %}
              {% set second_games = stats.champions[1].games %}
              {% set ratio_needed = [2.0 - (champ.games - 10) * 0.0125, 1.5]|max %}
              {% if champ.games >= 20 and second_games <= 2 %}
              <span class="otp-badge">OTP</span>
              {% elif second_games > 0 and champ.games / second_games >= ratio_needed %}
              <span class="main-badge">MAIN</span>
              {% endif %}
              {% elif loop.index == 1 and stats.champions|length == 1 and champ.games >= 20 %}
              <span class="otp-badge">OTP</span>
              {% endif %}
            </div>
            <span class="champ-games">{{ champ.games }}g</span>
            <div class="wr-bar-container">
              <div class="wr-bar" style="width: {{ champ.winrate }}%"></div>
              <span class="wr-text {{ 'good' if champ.winrate >= 55 else 'bad' if champ.winrate < 48 else '' }}">
                {{ champ.winrate }}%
              </span>
            </div>
            <span class="champ-kda">{{ champ.kda }} KDA</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="muted">No ranked champion data available.</p>
        {% endif %}
      </div>

      <div class="player-tab-panel" data-tab="mastery" style="display:none">
        {% if stats.masteries %}
        <div class="champ-list">
          <div class="champ-list-header mastery-header">
            <span>Champion</span><span>Level</span><span>Points</span><span>Last Played</span>
          </div>
          {% for m in stats.masteries[:15] %}
          <div class="champ-row">
            <div class="champ-info">
              <img class="champ-icon" src="{{ m.champion_key|champion_icon }}"
                   alt="{{ m.champion_name }}"
                   onerror="this.style.display='none'">
              <span class="champ-name">{{ m.champion_name }}</span>
            </div>
            <span class="mastery-level">Lvl {{ m.level }}</span>
            <span class="mastery-points">{{ "{:,}".format(m.points) }}</span>
            <span class="mastery-date muted">{{ m.last_played[:10] if m.last_played else '—' }}</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="muted">No mastery data available. Refresh to fetch.</p>
        {% endif %}
      </div>
      {% else %}
      <p class="muted">No data yet. Click refresh to fetch from op.gg.</p>
      {% endif %}

      <div class="player-footer">
        {% if stats and stats.opgg_url %}
        <a href="{{ stats.opgg_url }}" target="_blank" rel="noopener" class="btn btn-sm">op.gg</a>
        {% endif %}
        {% if stats %}
        <span class="muted">Updated: {{ stats.last_updated[:16].replace('T', ' ') }}</span>
        {% endif %}
        <button class="btn btn-sm" onclick="refreshPlayer('{{ player.id }}', this)">Refresh</button>
        <button class="btn btn-sm btn-danger" onclick="deletePlayer('{{ player.id }}')">Remove</button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

{% if subs %}
<h2 class="section-title">Substitutes</h2>
<div class="player-list">
  {% for player in subs %}
  {% set stats = player.stats %}
  <div class="player-card sub-card" data-player="{{ player.id }}">
    <div class="player-header" onclick="togglePlayer(this)">
      <span class="role-tag role-{{ player.role }}">{{ player.role[:3].upper() }}</span>
      <span class="player-name">{{ player.game_name }}<span class="tag">#{{ player.tag_line }}</span></span>
      <span class="sub-badge">SUB</span>
      {% if stats %}
      {% set cur_higher = player|current_higher_than_peak %}
      {% if stats.peak_tier %}
      {% if cur_higher %}
      <span class="current-rank-inline">Peak: {{ stats.peak_tier }}</span>
      {% else %}
      <span class="tier-badge" style="color: {{ stats.peak_tier|peak_color }}">Peak: {{ stats.peak_tier }}</span>
      {% endif %}
      {% endif %}
      {% if cur_higher %}
      <span class="tier-badge" style="color: {{ stats.tier|tier_color }}">Cur: {{ player|tier_display }}</span>
      {% else %}
      <span class="current-rank-inline">Cur: {{ player|tier_display }}</span>
      {% endif %}
      <span class="wr-badge">{{ stats.season_winrate }}% WR</span>
      {% endif %}
      <span class="expand-arrow">&#9660;</span>
    </div>

    <div class="player-body" style="display:none">
      {% if stats and stats.champions %}
      <div class="champ-list">
        <div class="champ-list-header">
          <span>Champion</span><span>Games</span><span>Win Rate</span><span>KDA</span>
        </div>
        {% for champ in stats.champions[:10] %}
        <div class="champ-row">
          <div class="champ-info">
            <img class="champ-icon" src="{{ champ.champion_key|champion_icon }}"
                 alt="{{ champ.champion_name }}"
                 onerror="this.style.display='none'">
            <span class="champ-name">{{ champ.champion_name }}</span>
          </div>
          <span class="champ-games">{{ champ.games }}g</span>
          <div class="wr-bar-container">
            <div class="wr-bar" style="width: {{ champ.winrate }}%"></div>
            <span class="wr-text">{{ champ.winrate }}%</span>
          </div>
          <span class="champ-kda">{{ champ.kda }} KDA</span>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="muted">No data yet.</p>
      {% endif %}
      <div class="player-footer">
        {% if stats and stats.opgg_url %}
        <a href="{{ stats.opgg_url }}" target="_blank" rel="noopener" class="btn btn-sm">op.gg</a>
        {% endif %}
        <button class="btn btn-sm" onclick="refreshPlayer('{{ player.id }}', this)">Refresh</button>
        <button class="btn btn-sm btn-danger" onclick="deletePlayer('{{ player.id }}')">Remove</button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}
{% endblock %}
